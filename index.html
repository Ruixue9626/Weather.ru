<!doctype html>
<html lang="zh-Hant">
<head>
  <!-- 網站圖標 / Favicon -->
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Ruixue9626/Weather.ru/8d5a7078107164aed7f99be2845dfd4af5709f1a/Weather-ru.png" />
  <link rel="shortcut icon" type="image/png" href="https://raw.githubusercontent.com/Ruixue9626/Weather.ru/8d5a7078107164aed7f99be2845dfd4af5709f1a/Weather-ru.png" />
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Ruixue9626/Weather.ru/8d5a7078107164aed7f99be2845dfd4af5709f1a/Weather-ru.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weather.ru</title>
  <style>
    html,body { 
      height:100%; margin:0; 
      font-family: "Segoe UI", Roboto, system-ui, -apple-system; 
      background-color: #DBE7F5;
      color: #000000;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body { 
      overflow-y:auto; 
      padding-bottom:200px; /* 增加底部空間，避免 footer 擋住內容 */
    }
    .banner {
      position:fixed; top:0; left:0; right:0; height:64px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; box-sizing:border-box;
      background: #A3BFD9;
      border-bottom-left-radius:12px;
      border-bottom-right-radius:12px;
      z-index:10;
      color: #000000;
    }
    .left, .center, .right { display:flex; align-items:center; gap:10px; }
    .left .brand { font-weight:700; font-size:20px; }
    .center .time { font-size:18px; font-weight:600; }
    .right .cond { font-size:16px; display:flex; align-items:center; gap:8px; }
    .main {
      margin-top: 120px;
      padding: 0 20px;
      text-align:center;
      text-shadow: none;
    }
    .main .big-temp { font-size:96px; font-weight:800; line-height:0.9; }
    .main .small { font-size:24px; margin-top:8px; opacity:0.95; }
    table.hourly-forecast {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 600px;
      font-size: 16px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
      color: #000;
    }
    table.hourly-forecast th, table.hourly-forecast td {
      padding: 10px 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    table.hourly-forecast th {
      background-color: #A3BFD9;
      font-weight: 700;
    }
    table.hourly-forecast tr:last-child td {
      border-bottom: none;
    }
    .footer {
      position:fixed;
      bottom:20px;
      width:100%;
      text-align:center;
      z-index:9;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: #000000;
      text-shadow: none;
    }
    .btn-detail {
      padding: 6px 18px;
      font-size: 16px;
      background-color: #A3BFD9;
      border: none;
      border-radius: 24px;
      color: #000000;
      cursor: pointer;
      box-shadow: none;
      transition: background-color 0.3s ease;
    }
    .btn-detail:hover {
      background-color: #89aadb;
    }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div class="banner" role="banner">
    <div class="left"><div class="brand">Weather.ru</div></div>
    <div class="center"><div class="time" id="time">--:-- --</div></div>
    <div class="right"><div class="cond" id="cond">-- ℃ · --</div></div>
  </div>

  <main class="main">
    <div class="big-temp" id="bigTemp">-- ℃</div>
    <div class="small" id="location">載入中...</div>

    <table class="hourly-forecast" aria-label="未來24小時天氣預報" id="hourlyTable">
      <thead>
        <tr><th>時間</th><th>天氣</th><th>溫度</th></tr>
      </thead>
      <tbody><tr><td colspan="3">載入中...</td></tr></tbody>
    </table>
    <div id="dataSource" style="margin: 24px auto 0 auto; color: #555; font-size: 15px; text-align: center; max-width: 600px;">
      資料來源：weatherapi.com
      <br>
      <br>
      <br> 
      <br> 
    </div>
  </main>

  <div class="footer" id="footer">
    <button class="btn-detail" id="multiActionBtn" type="button">
      詳細天氣<span style="margin: 0 10px; color: #666;">｜</span>設定地區
    </button>
  </div>

  <script>
    let CITY = localStorage.getItem('weather_city') || 'Taichung';
    const API_KEY = '177eb0e0b74c4d6387812011250908';
    const WEATHER_REFRESH_MS = 5 * 60 * 1000;

    // 中文天氣關鍵詞字典（包含常用詞）
    const dict = {
      partly: '部分',
      patchy: '局部',
      light: '輕微',
      moderate: '中度',
      heavy: '大量',
      rain: '雨',
      shower: '陣雨',
      showers: '陣雨',
      snow: '雪',
      sleet: '凍雨',
      freezing: '凍',
      drizzle: '毛毛雨',
      thunder: '雷雨',
      possible: '可能',
      cloudy: '多雲',
      clear: '晴朗',
      sunny: '晴天',
      fog: '霧',
      mist: '霧',
      blizzard: '暴風雪',
      blowing: '吹',
      pellets: '冰粒',
      overcast: '陰天',
      outbreaks: '陣雨',
    };

    function cleanAndTranslate(eng) {
      eng = eng.replace(/nearby/gi, '').replace(/[^\w\s\-]/g, '').trim();
      const words = eng.toLowerCase().split(/\s+|\-/);
      let resultWords = [];

      for (const w of words) {
        if (dict[w]) {
          resultWords.push(dict[w]);
        } else {
          // 不在字典的直接用原詞（保留原意）
          resultWords.push(w);
        }
      }

      // 合理組合：中文詞之間無空格，英文詞保留空格（避免硬翻）
      let result = '';
      for (let i = 0; i < resultWords.length; i++) {
        const word = resultWords[i];
        if (/^[\u4e00-\u9fff]+$/.test(word)) {
          // 中文直接連接
          result += word;
        } else {
          // 英文用空格分開
          result += (result ? ' ' : '') + word;
        }
      }

      // 首字母大寫
      if (result.length > 0) result = result[0].toUpperCase() + result.slice(1);
      return result;
    }

    function updateTime(localIso=null) {
      let d = localIso ? new Date(localIso) : new Date();
      let h = d.getHours();
      const m = d.getMinutes();
      const ampm = h >= 12 ? 'PM' : 'AM';
      h = h % 12;
      if (h === 0) h = 12;
      const mm = m.toString().padStart(2,'0');
      document.getElementById('time').textContent = `${h}:${mm} ${ampm}`;
    }

    function formatHourlyRow(hourData) {
      const dt = new Date(hourData.time);
      const month = dt.getMonth() + 1;
      const date = dt.getDate();
      const hh = dt.getHours().toString().padStart(2, '0');
      const mm = dt.getMinutes().toString().padStart(2, '0');
      const timeStr = `${month}/${date} ${hh}:${mm}`;

      const condEng = hourData.condition.text;
      const condZh = cleanAndTranslate(condEng);
      const temp = Math.round(hourData.temp_c);

      return `<tr><td>${timeStr}</td><td>${condZh}</td><td>${temp}°C</td></tr>`;
    }

    async function fetchWeather() {
      try {
        const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(CITY)}&days=2&aqi=no&alerts=no`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('取得天氣失敗');
        const data = await res.json();

        const temp = Math.round(data.current.temp_c);
        const condEng = data.current.condition.text;
        const condZh = cleanAndTranslate(condEng);
        const loc = data.location.name + (data.location.region ? ', ' + data.location.region : '') + ' · ' + data.location.country;

        document.getElementById('cond').textContent = `${temp} ℃ · ${condZh}`;
        document.getElementById('bigTemp').textContent = `${temp} ℃`;
        document.getElementById('location').textContent = loc;

        if (data.location && data.location.localtime) {
          const lt = data.location.localtime.replace(' ', 'T');
          updateTime(lt);
        } else {
          updateTime();
        }

        let hourlyData = [];
        if (data.forecast && data.forecast.forecastday && data.forecast.forecastday.length > 0) {
          const todayHours = data.forecast.forecastday[0].hour;
          const tomorrowHours = data.forecast.forecastday[1]?.hour || [];
          hourlyData = todayHours.concat(tomorrowHours);
        }

        const nowTime = new Date(data.location.localtime.replace(' ', 'T')).getTime();
        const next24Hours = hourlyData.filter(h => new Date(h.time).getTime() >= nowTime).slice(0,24);

        if (next24Hours.length === 0) {
          document.querySelector('#hourlyTable tbody').innerHTML = `<tr><td colspan="3">無未來24小時資料</td></tr>`;
        } else {
          document.querySelector('#hourlyTable tbody').innerHTML = next24Hours.map(formatHourlyRow).join('');
        }
      } catch (err) {
        console.error(err);
        document.getElementById('cond').textContent = '-- ℃ · 無資料';
        document.getElementById('bigTemp').textContent = '-- ℃';
        document.getElementById('location').textContent = '無法取得資料';
        document.querySelector('#hourlyTable tbody').innerHTML = `<tr><td colspan="3">無法取得未來資料</td></tr>`;
      }
    }

    document.getElementById('multiActionBtn').onclick = function(e) {
      // 取得滑鼠點擊位置
      const btn = e.target.closest('button');
      const rect = btn.getBoundingClientRect();
      const x = e.clientX - rect.left;
      // 詳細天氣在左半，設定地區在右半
      if (x < rect.width / 2) {
        window.open('https://www.msn.com/zh-tw/weather/', '_blank');
      } else {
        const city = prompt('請輸入城市名稱（英文或中文皆可）', CITY);
        if (city && city.trim()) {
          CITY = city.trim();
          localStorage.setItem('weather_city', CITY);
          fetchWeather();
        }
      }
    };

    updateTime();
    fetchWeather();
    setInterval(() => updateTime(), 1000);
    setInterval(fetchWeather, WEATHER_REFRESH_MS);
  </script>
</body>
</html>
